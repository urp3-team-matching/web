name: Supabase Keep-Alive

on:
  schedule:
    # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ë§¤ì‹œ ì •ê°)
    - cron: "0 * * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      debug:
        description: "Debug mode (sends email even on success)"
        required: false
        type: boolean
        default: false

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase keep-alive endpoint
        run: |
          echo "ğŸš€ Calling keep-alive endpoint..."
          echo "ğŸ› Debug mode: ${{ github.event.inputs.debug || 'false' }}"

          DEBUG_PARAM=""
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            DEBUG_PARAM="?debug=true"
            echo "ğŸ“§ Debug mode enabled: Will send email notification regardless of result"
          fi

          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            "${{ secrets.VERCEL_DEPLOYMENT_URL }}/api/cron/keep-alive${DEBUG_PARAM}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ğŸ“Š Response Status: $http_code"
          echo "ğŸ“ Response Body:"
          echo "$body" | jq '.' || echo "$body"

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "âœ… Keep-alive successful!"
            exit 0
          else
            echo "âŒ Keep-alive failed with status $http_code"
            exit 1
          fi
        env:
          TZ: "Asia/Seoul"

      - name: Log execution
        if: always()
        run: |
          echo "â° Execution time: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸŒ Timezone: Asia/Seoul"
